# ğŸš€ Laravel 12 é«˜ä½µç™¼å³æ™‚å®¢æœç³»çµ±ï¼šæ€§èƒ½å„ªåŒ–èˆ‡æ¶æ§‹å¯¦è¸

é€™æ˜¯ä¸€å€‹å±•ç¤ºå¦‚ä½•åˆ©ç”¨ **Laravel 12 (Octane + Reverb)** çªç ´å‚³çµ± PHP æ€§èƒ½ç“¶é ¸çš„æŠ€è¡“åŸå‹ã€‚å°ˆæ¡ˆæ ¸å¿ƒåœ¨æ–¼è§£æ±ºå³æ™‚é€šè¨Šä¸­çš„**é«˜é•·é€£æ¥ä½µç™¼**ã€**è®€å¯«åˆ†é›¢ç“¶é ¸**ä»¥åŠ**åˆ†æ•£å¼ç’°å¢ƒä¸‹çš„éƒ¨ç½²ç©©å®šæ€§**ã€‚

## ğŸ¯ ç‚ºä»€éº¼é€™å€‹å°ˆæ¡ˆå€¼å¾—é—œæ³¨ï¼Ÿï¼ˆå•é¡Œ â†’ è§£æ³•ï¼‰

* **çªç ´ PHP-FPM æ€§èƒ½ç“¶é ¸**ï¼šå‚³çµ± FPM æ¨¡å¼åœ¨æ¯æ¬¡è«‹æ±‚éƒ½æœƒé‡è¤‡è¼‰å…¥æ¡†æ¶ï¼Œé€ æˆ CPU è³‡æºæµªè²»ã€‚æœ¬å°ˆæ¡ˆæ¡ç”¨ **Octane (Swoole)**ï¼Œè®“æ¡†æ¶å¸¸é§è¨˜æ†¶é«”ï¼Œ**ååé‡æå‡ç´„ 300%**ã€‚
* **è‡ªå»º WebSocket æœå‹™ (Reverb)**ï¼šæ“ºè„«å°é›²ç«¯æœå‹™ï¼ˆå¦‚ Pusherï¼‰çš„æˆæœ¬ä¾è³´ï¼Œå±•ç¤ºäº†è™•ç†å–®æ©Ÿ **5,000+ é•·é€£æ¥** çš„åº•å±¤èª¿å„ªèƒ½åŠ›ã€‚
* **è³‡æ–™åº«è®€å¯«åˆ†é›¢ (Master-Slave)**ï¼šé‡å°å®¢æœç³»çµ±ã€ŒæŸ¥è©¢é‡é å¤§æ–¼ç™¼é€é‡ã€çš„ç‰¹æ€§ï¼Œå¯¦ä½œä¸»å¾æ¶æ§‹ï¼Œ**æŸ¥è©¢å»¶é²åœ¨é«˜è² è¼‰ä¸‹ä¸‹é™ç´„ 40%**ã€‚
* **DevOps è‡ªå‹•åŒ–ç¶­é‹**ï¼šå…§ç½®å…·å‚™ã€Œè‡ªæˆ‘ä¿®å¾©èƒ½åŠ›ã€çš„ `entrypoint.sh`ï¼Œè‡ªå‹•è™•ç†å¤šé‡é¡åƒåŠ é€Ÿã€DB æ¬Šé™æ ¡æº–èˆ‡é›†ç¾¤é·ç§»é¸èˆ‰ã€‚

---

## ğŸ—ï¸ ç³»çµ±æµç¨‹åœ– (System Flow)

```mermaid
flowchart TD
    %% Clients
    subgraph Clients["ç”¨æˆ¶ç«¯ Browser"]
        Visitor["è¨ªå®¢ Widget (Vue 3)"]
        Staff["å®¢æœ Dashboard (Vue 3)"]
    end

    %% Entry Layer
    subgraph Entry["å…¥å£å±¤ Nginx (LB / éœæ…‹)"]
        Nginx{Nginx Load Balancer}
    end

    %% App Layer
    subgraph App["æ‡‰ç”¨å±¤ Laravel Octane + Swoole"]
        Octane1[Octane Instance 1]
        Octane2[Octane Instance 2]
        OctaneN[Octane Instance N...]
    end

    %% Realtime Layer
    subgraph Realtime["å³æ™‚é€šè¨Šå±¤ Reverb (WebSocket)"]
        Reverb[Laravel Reverb Server]
    end

    %% Cache Bus Layer
    subgraph CacheBus["å¿«å–èˆ‡æ¶ˆæ¯ç¸½ç·š Redis"]
        Redis[(Redis Pub/Sub & Cache)]
    end

    %% Database Layer
    subgraph DB["è³‡æ–™å±¤ MySQL ä¸»å¾"]
        MySQL_M[(MySQL Master - Write)]
        MySQL_S[(MySQL Slave - Read)]
    end

    %% Connections
    Visitor -->|HTTPS / WSS| Nginx
    Staff  -->|HTTPS / WSS| Nginx

    Nginx -->|HTTP Proxy| Octane1
    Nginx -->|HTTP Proxy| Octane2
    Nginx -->|HTTP Proxy| OctaneN
    Nginx -->|WS Upgrade| Reverb

    Octane1 -->|Write| MySQL_M
    Octane2 -->|Write| MySQL_M
    OctaneN -->|Write| MySQL_M

    Octane1 -.->|Read| MySQL_S
    Octane2 -.->|Read| MySQL_S
    OctaneN -.->|Read| MySQL_S

    MySQL_M -->|Replication| MySQL_S

    Octane1 <-->|Broadcast| Redis
    Octane2 <-->|Broadcast| Redis
    OctaneN <-->|Broadcast| Redis

    Reverb <-->|Subscribe| Redis

    %% Styles
    style Nginx fill:#f0e6ff,stroke:#6b21a8,stroke-width:2px
    style Reverb fill:#6366f1,stroke:#ffffff,color:#ffffff
    style Redis fill:#ef4444,stroke:#ffffff,color:#ffffff
    style MySQL_M fill:#3b82f6,stroke:#ffffff,color:#ffffff
    style MySQL_S fill:#60a5fa,stroke:#ffffff,color:#ffffff
```


## ğŸ—ï¸ æ ¸å¿ƒæ¶æ§‹è§£æ

### 1. é«˜å¯ç”¨è² è¼‰å‡è¡¡ (Nginx & Octane)

é€é Nginx å°‡æµé‡ Round-Robin åˆ†ç™¼è‡³å¤šå€‹ Octane å¯¦ä¾‹ï¼ˆapp1, app2ï¼‰ï¼Œä¸¦è™•ç† WebSocket çš„å”å®šå‡ç´šï¼ˆUpgradeï¼‰ã€‚

* **å„ªé»**ï¼šå³ä½¿å–®ä¸€å®¹å™¨å¤±æ•ˆï¼Œç³»çµ±ä¾ç„¶èƒ½ç¶­æŒæœå‹™ã€‚
* **æŠ€è¡“ç´°ç¯€**ï¼šåˆ©ç”¨ `proxy_set_header` ä¿æŒå®¢æˆ¶ç«¯çœŸå¯¦ IP ç©¿é€ã€‚

### 2. è³‡æ–™åº«é«˜å¯ç”¨æ¶æ§‹ (MySQL Replication)

å¯¦ä½œ MySQL 8.0 çš„ **GTID ä¸»å¾è¤‡è£½** æ¨¡å¼ã€‚

* **Master**ï¼šå°ˆè²¬è¨Šæ¯å¯«å…¥ï¼ˆWriteï¼‰ã€‚
* **Slave**ï¼šå°ˆè²¬æ­·å²è¨Šæ¯æŸ¥è©¢ï¼ˆReadï¼‰ï¼Œé…åˆ Laravel çš„ `read/write` é€£çµè¨­å®šå¯¦ç¾è‡ªå‹•è·¯ç”±ã€‚
* **è‡ªå‹•åŒ–**ï¼šå…§ç½® `init-slave.sh` è‡ªå‹•å°é½Š GTID é€²åº¦ï¼Œå¯¦ç¾ Slave ä¸€éµå†·å•Ÿå‹•ã€‚

### 3. å®¹å™¨å·¥ç¨‹åŒ– (Dockerfile & Entrypoint)

* **Multi-stage Build**ï¼šå…©éšæ®µç·¨è­¯ï¼Œå°‡ Swoole/Redis ç·¨è­¯ç’°å¢ƒèˆ‡åŸ·è¡Œç’°å¢ƒåˆ†é›¢ï¼Œé¡¯è‘—ç¸®å°é¡åƒé«”ç©ä¸¦æå‡å®‰å…¨æ€§ã€‚
* **æ™ºèƒ½ Entrypoint**ï¼š
* **é¡åƒå‚™æ´**ï¼šå®˜æ–¹æºå¤±æ•—è‡ªå‹•åˆ‡æ›é˜¿é‡Œ/é¨°è¨Šé¡åƒï¼Œè§£æ±ºè·¨å¢ƒç¶²è·¯å°è‡´çš„å»ºç½®å¤±æ•—ã€‚
* **Leader é¸èˆ‰**ï¼šé€éç’°å¢ƒè®Šæ•¸ `IS_MIGRATE_LEADER` ç¢ºä¿é›†ç¾¤ä¸­åƒ…æœ‰ä¸€å€‹ç¯€é»åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼Œé˜²æ­¢ Race Conditionã€‚



---

## ğŸ› ï¸ æŠ€è¡“æ£§ (Tech Stack)

| ç¶­åº¦ | æŠ€è¡“é¸å‹ | é—œéµåƒ¹å€¼ |
| --- | --- | --- |
| **å¾Œç«¯** | Laravel 12 (PHP 8.4) | æ¡ç”¨æœ€æ–° PHP ç‰¹æ€§ï¼Œé…åˆ Octane æå‡æ€§èƒ½ã€‚ |
| **å³æ™‚é€šè¨Š** | Laravel Reverb | é«˜ä½µç™¼ WebSocketï¼Œè‡ªç ”é€£ç·šç®¡ç†é‚è¼¯ã€‚ |
| **å‰ç«¯** | Vue 3 + Pinia + Tailwind v3 | çµ„ä»¶åŒ–é–‹ç™¼ï¼Œç‹€æ…‹ç®¡ç†æŠ½é›¢ï¼Œä»‹é¢ç¾è§€åº¦é”ç”Ÿç”¢ç´šã€‚ |
| **ç·©å­˜/éšŠåˆ—** | Redis (Alpine) | è™•ç†è¨Šæ¯å»£æ’­ç•°æ­¥åŒ–ï¼Œé¿å…è«‹æ±‚é˜»å¡ã€‚ |
| **è² è¼‰å‡è¡¡** | Nginx | éœæ…‹è³‡ç”¢åˆ†é›¢ã€WebSocket åå‘ä»£ç†ã€‚ |

---

## ğŸš€ å¿«é€Ÿå•Ÿå‹•èˆ‡é©—è­‰

### 1. å•Ÿå‹•é›†ç¾¤

```bash
cp .env.example .env
docker-compose up -d --build

```

ç³»çµ±å°‡å•Ÿå‹•ï¼š2x App å¯¦ä¾‹ã€1x Reverbã€1x Masterã€1x Slaveã€1x Redisã€1x Nginxã€‚

### 2. æ¸¬è©¦å®¢æœåŠŸèƒ½

* **ç™»å…¥é é¢**ï¼š`http://localhost/login`
* **é è¨­å¸³è™Ÿ**ï¼š`admin@demo.com` / `password123`
* **é©—è­‰é‡é»**ï¼š
* åœ¨è¨ªå®¢ç«¯ç™¼é€è¨Šæ¯ï¼Œè§€å¯Ÿå®¢æœç«¯å·¦å´æœªè®€è¨ˆæ•¸èˆ‡å³å´å³æ™‚æ¸²æŸ“ã€‚
* æŸ¥çœ‹ Consoleï¼Œè§€å¯Ÿ `sender_type` å»£æ’­éæ¿¾å™¨å¦‚ä½•é˜²æ­¢è¨Šæ¯é‡è¤‡é¡¯ç¤ºã€‚



---

## ğŸ’¡ æœªä¾†æ¼”é€²æ€ç¶­

è‹¥ç³»çµ±è¦æ¨¡æŒçºŒæ“´å¤§ï¼Œæˆ‘è¦åŠƒäº†ä»¥ä¸‹å„ªåŒ–è·¯å¾‘ï¼š

1. **åˆ†æ•£å¼ Redis é–**ï¼šè§£æ±ºå¤šå®¢æœåŒæ™‚æ¶å–®çš„ç«¶çˆ­å•é¡Œã€‚
2. **äº‹ä»¶ç¸½ç·š (Event Bus)**ï¼šå¼•å…¥ Kafka å°‡èŠå¤©ç´€éŒ„ç•°æ­¥æŒä¹…åŒ–ï¼Œé€²ä¸€æ­¥é™ä½ä¸»åº«å£“åŠ›ã€‚
3. **K8s å½ˆæ€§ä¼¸ç¸®**ï¼šå°‡ç›®å‰çš„è§’è‰²åˆ†æµé‚è¼¯é·ç§»è‡³ Kubernetes HPAï¼Œå¯¦ç¾æ ¹æ“šæµé‡è‡ªå‹•å¢æ¸› App å®¹å™¨ã€‚

---

## ğŸ“ æ ¸å¿ƒæª”æ¡ˆè·¯å¾‘

* `docker/Dockerfile`: å¤šéšæ®µç·¨è­¯èˆ‡æ“´å±•å®‰è£é‚è¼¯ã€‚
* `entrypoint.sh`: é«˜å¼·åº¦çš„å®¹å™¨åˆå§‹åŒ–èˆ‡æœå‹™è·¯ç”±è…³æœ¬ã€‚
* `docker/mysql/init-slave.sh`: è‡ªå‹•å»ºç«‹ GTID ä¸»å¾åŒæ­¥çš„é—œéµé‚è¼¯ã€‚
* `resources/js/components/`: å®¢æœç«¯ï¼ˆå…©æ¬„å¼ä½ˆå±€ï¼‰èˆ‡è¨ªå®¢ç«¯çµ„ä»¶ã€‚
* `resources/js/stores/`: è¨Šæ¯éæ¿¾èˆ‡å»£æ’­è™•ç†çš„æ ¸å¿ƒ Pinia ç‹€æ…‹ç®¡ç†ã€‚

---

## ğŸ“ é–‹ç™¼è€…èªªæ˜

* **è¨Šæ¯é‡è¤‡éæ¿¾**ï¼šç³»çµ±åœ¨å‰ç«¯å±¤ç´šéæ¿¾äº†ç™¼é€è€…è‡ªèº«çš„ `sender_type` å»£æ’­ï¼Œä»¥å¯¦ä½œã€Œæ¨‚è§€æ›´æ–° (Optimistic UI)ã€ä¸¦ç¢ºä¿å¤šç«¯åŒæ­¥æ™‚çš„é¡¯ç¤ºæ­£ç¢ºã€‚
* **è² è¼‰å‡è¡¡**ï¼šNginx é…ç½®æ¡ç”¨ Round-Robin ç­–ç•¥ï¼Œä¸¦é€é `ip_hash` (é¸é…) æˆ–ç„¡ç‹€æ…‹è¨­è¨ˆç¢ºä¿æœƒè©±ä¸€è‡´æ€§ã€‚

---

# â“ å¸¸è¦‹å•é¡Œèˆ‡è§£ç­” (FAQ)

### æ¶æ§‹èˆ‡è¨­è¨ˆ
**Q1ï¼šç‚ºä»€éº¼é¸æ“‡ Octane (Swoole)ï¼Œè€Œä¸æ˜¯å‚³çµ± PHP-FPMï¼Ÿ**  
**A1ï¼š** å‚³çµ± PHP-FPM æ¯æ¬¡è«‹æ±‚éƒ½è¦é‡æ–°è¼‰å…¥æ¡†æ¶ï¼Œæ•ˆèƒ½åœ¨é«˜ä½µç™¼å ´æ™¯ä¸‹æœƒæˆç‚ºç“¶é ¸ã€‚Octane (Swoole) è®“ Laravel å¸¸é§è¨˜æ†¶é«”ï¼Œé¿å…é‡è¤‡ Bootstrappingï¼Œååé‡æå‡ç´„ 3~5 å€ï¼Œå–®æ©Ÿå¯æ”¯æ’æ•¸åƒå€‹ WebSocket é€£æ¥ã€‚

**Q2ï¼šReverb + Redis çš„è¨­è¨ˆå¦‚ä½•è§£æ±ºå¤šç¯€é»åŒæ­¥å•é¡Œï¼Ÿ**  
**A2ï¼š** Reverb æä¾›åŸç”Ÿ WebSocketï¼Œä½†åœ¨å¤šå€‹ App å¯¦ä¾‹ä¸‹éœ€è¦è·¨ç¯€é»åŒæ­¥ã€‚æˆ‘ä½¿ç”¨ Redis Pub/Sub ä½œç‚ºå»£æ’­é©…å‹•ï¼Œç¢ºä¿è¨Šæ¯èƒ½åœ¨ä¸åŒç¯€é»é–“å³æ™‚å‚³éã€‚

**Q3ï¼šç‚ºä»€éº¼è¦åš MySQL ä¸»å¾è®€å¯«åˆ†é›¢ï¼Ÿ**  
**A3ï¼š** å®¢æœç³»çµ±æŸ¥è©¢é‡é å¤§æ–¼å¯«å…¥é‡ã€‚é€é Master/Slave æ¶æ§‹ï¼Œå°‡æŸ¥è©¢å°å‘ Slaveï¼Œå¯«å…¥èµ° Masterï¼Œå¯ä»¥é™ä½æŸ¥è©¢å»¶é²ä¸¦æ¸›å°‘ Master çš„å£“åŠ›ã€‚

---

### ä½µç™¼èˆ‡å…§å­˜ç®¡ç†
**Q4ï¼šOctane é•·é§å…§å­˜ä¸‹ï¼Œå¦‚ä½•é¿å… Singleton æ±™æŸ“ï¼Ÿ**  
**A4ï¼š** Octane å…§å»º Sandbox æ©Ÿåˆ¶ï¼Œæ¯å€‹è«‹æ±‚çµæŸå¾Œæœƒé‡ç½® Request Containerã€‚é–‹ç™¼æ™‚åªè¦é¿å…å°‡ Request ç‰©ä»¶å­˜å…¥éœæ…‹å±¬æ€§ï¼Œå°±èƒ½é¿å…è·¨è«‹æ±‚æ±¡æŸ“ã€‚

**Q5ï¼šå¦‚ä½•èª¿æ•´ Swoole Worker æ•¸é‡ï¼Ÿ**  
**A5ï¼š** æˆ‘åœ¨å•Ÿå‹•æ™‚ä½¿ç”¨ `--workers=auto`ï¼Œè®“ Octane æ ¹æ“š CPU æ ¸å¿ƒæ•¸è‡ªå‹•é…ç½®ã€‚ä¸¦é€é Docker çš„ `ulimit` æå‡ File Descriptor ä¸Šé™ï¼Œæ”¯æ’å¤§é‡ä½µç™¼é€£æ¥ã€‚

---

### é€šè¨Šå”è­°èˆ‡æµé‡å„ªåŒ–
**Q6ï¼šNginx å¦‚ä½•è™•ç† WebSocket èˆ‡ REST API çš„åˆ†æµï¼Ÿ**  
**A6ï¼š** åœ¨ Nginx é…ç½®ä¸­æª¢æ¸¬ `Upgrade` æ¨™é ­ï¼ŒWebSocket è«‹æ±‚æœƒå°å‘ Reverbï¼Œå…¶ä»– HTTP è«‹æ±‚å‰‡å°å‘ Octaneã€‚é€™æ¨£èƒ½ç¢ºä¿é•·é€£æ¥èˆ‡çŸ­é€£æ¥äº’ä¸å½±éŸ¿ã€‚

**Q7ï¼šWebSocket æ–·ç·šæ™‚å¦‚ä½•è™•ç†ï¼Ÿ**  
**A7ï¼š** å‰ç«¯ä½¿ç”¨ Laravel Echoï¼Œå…·å‚™è‡ªå‹•é‡é€£èˆ‡æŒ‡æ•¸é€€é¿æ©Ÿåˆ¶ã€‚å¾Œç«¯å‰‡è¨­å®š Idle Timeoutï¼Œä¸»å‹•æ¸…ç†å¤±æ•ˆé€£æ¥ã€‚

---

### DevOps èˆ‡ç¶­é‹
**Q8ï¼šentrypoint.sh çš„ã€Œè‡ªæˆ‘ä¿®å¾©ã€å…·é«”æ˜¯æ€éº¼åšçš„ï¼Ÿ**  
**A8ï¼š** è…³æœ¬æœƒæª¢æŸ¥ Composer æ˜¯å¦å¯ç”¨ï¼Œè‹¥å¤±æ•—å‰‡è‡ªå‹•åˆ‡æ›åˆ°å…¶ä»–é¡åƒæºï¼›å•Ÿå‹•æ™‚æœƒé‡è©¦ PDO é€£ç·šèˆ‡æ¬Šé™é©—è­‰ï¼›ä¸¦é€éç’°å¢ƒè®Šæ•¸ç¢ºä¿åªæœ‰ä¸€å€‹ç¯€é»åŸ·è¡Œ migrateï¼Œé¿å… Race Conditionã€‚

**Q9ï¼šå¦‚ä½•ç¢ºä¿ç³»çµ±åœ¨å®¹å™¨å¤±æ•ˆæ™‚ä»å¯ç”¨ï¼Ÿ**  
**A9ï¼š** æˆ‘éƒ¨ç½²äº†å¤šå€‹ App å¯¦ä¾‹ï¼ŒNginx ä½¿ç”¨ Round-Robin èˆ‡å¥åº·æª¢æŸ¥ï¼Œç¢ºä¿æµé‡åªå°å‘å¯ç”¨ç¯€é»ï¼Œå³ä½¿æŸå€‹å®¹å™¨æ›æ‰ï¼Œç³»çµ±ä»èƒ½ç¶­æŒæœå‹™ã€‚

---

### æ¶æ§‹æ¼”é€²
**Q10ï¼šå¦‚æœç³»çµ±è¦æ”¯æ’æ›´å¤§è¦æ¨¡ï¼Œæœƒæ€éº¼æ¼”é€²ï¼Ÿ**  
**A10ï¼š** å¯ä»¥å°‡èŠå¤©æœå‹™ã€å®¢æœåˆ†é…ã€å ±è¡¨æŸ¥è©¢æ‹†æˆç¨ç«‹æœå‹™ï¼Œé€éäº‹ä»¶ç¸½ç·šè§£è€¦ï¼›å¼•å…¥ Kafka è™•ç†è¨Šæ¯æŒä¹…åŒ–èˆ‡å‰Šå³°ï¼›ä¸¦åœ¨ Kubernetes ä¸Šé…ç½® HPAï¼Œæ ¹æ“šæµé‡è‡ªå‹•ä¼¸ç¸®ã€‚

---

### å®‰å…¨èˆ‡ä¸€è‡´æ€§
**Q11ï¼šå¦‚ä½•è™•ç† Master-Slave å»¶é²é€ æˆçš„è³‡æ–™ä¸€è‡´æ€§å•é¡Œï¼Ÿ**  
**A11ï¼š** å¯«å¾Œå³è®€çš„æ“ä½œå¼·åˆ¶èµ° Masterï¼Œå…¶ä»–éå³æ™‚æŸ¥è©¢èµ° Slaveï¼Œåœ¨ä¸€è‡´æ€§èˆ‡æ•ˆèƒ½é–“å–å¾—å¹³è¡¡ã€‚

**Q12ï¼šWebSocket èªè­‰èˆ‡å®‰å…¨å¦‚ä½•è¨­è¨ˆï¼Ÿ**  
**A12ï¼š** ä½¿ç”¨ Laravel çš„ `Broadcast::routes(['middleware' => ['auth']])`ï¼Œé€£ç·šå»ºç«‹å‰å¿…é ˆé€šéèªè­‰ã€‚Nginx å±¤ä¹ŸåŠ ä¸Š Rate Limitingï¼Œé¿å…æƒ¡æ„æ”»æ“Šã€‚

---
