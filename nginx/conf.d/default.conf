# 定義 Octane 後端群組（負載均衡）
upstream octane_backend {
    # 輪詢負載均衡（Round-Robin）
    server app1:8000;
    server app2:8000;
    # 可選：最小連接數策略
    # least_conn;
    # 可選：會話保持（適合需要登入狀態）
    # ip_hash;
}

server {
    listen 80;
    server_name localhost;

    root /var/www/html/public;
    index index.html;

    charset utf-8;

    # 靜態資源直接提供（Vite build 產出）
    location /build/ {
        try_files $uri =404;
    }

    location / {
        try_files $uri @octane;
    }

    location @octane {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 負載均衡轉發到多個 Octane 實例
        proxy_pass http://octane_backend;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
    }

    # Laravel Reverb WebSocket（單實例直通）
    location /app {
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_pass http://reverb:8080;
    }

    # 禁止存取隱藏檔案
    location ~ /\. {
        deny all;
    }
}